import{G as et,M as b,B as m,I as Se,O as Fe,C as Wt,V as L,S as ke,a as se,b as h,P as Kt,E as Ce,c as Pt,d as Ee,D as Ge,e as Le,f as He,g as Re,h as ie,i as Ae,F as qe,j as $e,W as We,k as Ue,l as Ve,A as Xe,m as Ke}from"./three-DUWuUrQd.js";import{c as Ye}from"./simplex-CZbXB3Em.js";import{g as Ze,$ as Nt}from"./peerjs-BmZC-Jli.js";import{r as Oe}from"./gun-Bg0fWSe3.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class je{constructor(t){this.chunkSize=t.chunkSize||32,this.tileSize=t.tileSize||1,this.chunks=new Map,this.mesh=new et,this.noise2D=Ye(),this.material=new b({color:16777215,roughness:.8}),this.islandCenters=[{x:-150,z:150,type:"ice"},{x:-150,z:-150,type:"volcanic"}],this.destroyedBlocks=new Set,this.placedBlocks=new Map,this.blockHealth=new Map,this.generateChunk(0,0)}getChunkKey(t,e){return`${t},${e}`}generateChunk(t,e,s=!1){const i=this.getChunkKey(t,e);if(this.chunks.has(i))if(s){const d=this.chunks.get(i);this.mesh.remove(d),d.dispose(),this.chunks.delete(i)}else return;const o=new m(this.tileSize,this.tileSize,this.tileSize),n=new Se(o,this.material,this.chunkSize*this.chunkSize*60);n.castShadow=!0,n.receiveShadow=!0;const c=new Fe;let a=0;const l=new Wt;for(let d=0;d<this.chunkSize;d++)for(let f=0;f<this.chunkSize;f++){const p=t*this.chunkSize+d,u=e*this.chunkSize+f;let y=1/0,w=null;for(const Z of this.islandCenters){const O=p-Z.x,B=u-Z.z,Dt=Math.sqrt(O*O+B*B);Dt<y&&(y=Dt,w=Z)}const x=50,g=p-w.x,k=u-w.z,I=g<-30&&Math.abs(k)<3,M=I&&g<-48&&g>-55;if(y>x&&!M)continue;const S=55,D=4,C=Math.floor(y/D)*D/x;let F=S*(1-C);const K=this.noise2D(p*.1,u*.1)*6;F+=K;const G=30;let Y=Math.floor(G-Math.max(2,F));M&&(Y=-30);let q=!1,H=0;const R=12,z=p-(w.x-30),P=u-w.z,tt=Math.sqrt(z*z+P*P);if(tt<R){q=!0;const Z=tt/R;H=Math.floor(4*(1-Z*Z))}let j=!1;const _=w.x,Q=w.z,$=p-_,X=u-Q;let W=Math.sqrt($*$+X*X);const V=4.5,ot=7,U=ot*4,ct=G+U;W<=V+2&&(j=!0);let vt=G;j&&(vt=ct+20),this.getTreeHeight(p,u);const at=w.type;let lt=6069830,pt=7032376,Mt=5921370,st=3355443,ht=4473924,J=4915330,ut=3801198,yt=6045747,kt=2263842,xt=16776960,dt=6045747,Rt=16753920,Ft=4474111,Ot=8947967;at==="ice"?(lt=16777215,pt=14544639,Mt=8947848,st=5596791,ht=4478310,J=2237013,ut=1118532,yt=4469538,kt=2250052,xt=11206655,dt=6715272,Rt=16777215,Ft=13434879,Ot=16777215):at==="arcane"?(lt=4915330,pt=3025759,Mt=4734347,st=2228292,ht=3342421,J=16766720,ut=14329120,yt=12632256,kt=16711935,xt=65535,dt=4915330,Rt=10040012):at==="volcanic"&&(lt=2755082,pt=1705221,Mt=1710618,st=5909034,ht=4856346,J=13378048,ut=11145472,yt=3346688,kt=16729344,xt=16755200,dt=8930372,Rt=16753920,Ft=16729344,Ot=16776960);for(let Z=Y;Z<=vt+8;Z++){if(this.destroyedBlocks.has(`${p},${Z},${u}`))continue;let O=!1,B=lt;if(Z<=G)if(O=!0,q){const E=G-H;Z>E?B=Ft:B=pt}else if(I){const ft=G-2;M?(B=Ft,Math.random()>.8&&(B=Ot)):Z>ft?B=Ft:B=pt}else{const E=G-Z;E===0?(B=lt,W<=V-1.5&&(B=J),at==="ice"&&Math.abs($)<2.5&&X<-4&&X>-48&&(B=8965375),at==="volcanic"&&Math.abs($)<2.5&&X>4&&X<48&&(B=2228224,Math.random()>.8&&(B=5570560),Math.random()>.95&&(B=16729344))):E<4?B=pt:B=Mt}if(j&&Z>G){const E=Z-G;if(at==="ice"||at==="volcanic")if(E<28){if(W<=V&&W>V-1.5){O=!0,B=Math.random()>.5?st:ht,E>5&&(E%7===3||E%7===4)&&(Math.abs($)<1||Math.abs(X)<1)&&W>V-1&&(B=1118498);const it=at==="ice"?-1:1;E<5&&X*it>0&&Math.abs($)<1.5&&(E<4?O=!1:B=yt),E===3&&X*it>0&&Math.abs($)>2&&Math.abs($)<3&&(O=!0,B=xt)}(E===27||E===26)&&W<=V+1&&W>V-1.5&&(O=!0,B=dt)}else{const it=E-28;if(it===0)W<=V+2.5&&(O=!0,B=J);else{const Ct=it*.1,At=Math.sin(it*.15)*Ct,Tt=$-At,jt=X,Be=Math.sqrt(Tt*Tt+jt*jt),ae=Math.max(0,V*(1-it/25));Be<=ae&&(O=!0,B=J,it>=1&&it<=3&&(B=Rt,it>=1.5&&it<=2.5&&jt>ae-1&&(B=16766720)))}}else if(E<=U+2){const ft=E%ot===0&&E<U,wt=E===U,it=E===U+1;let Ct=V;if(ft&&(Ct=V+.5),wt&&(Ct=V+1.5),it&&(Ct=V+1.5),W<=Ct&&W>Ct-1.5){if(O=!0,B=ft?dt:Math.random()>.5?st:ht,wt&&(B=dt),it){const Tt=Math.atan2(X,$)*(180/Math.PI);Math.abs(Tt%45)<15?O=!1:B=dt}if(E<5&&X>0&&Math.abs($)<1.5&&!wt&&!it&&(B=yt,E>3?O=!0:O=!1),!ft&&E>7&&E<U){const At=Math.abs($)<1||Math.abs(X)<1,Tt=E%ot;At&&Tt>=2&&Tt<=4&&(B=xt)}}}else{const ft=E-(U+2),wt=12,Ct=(V+.5)*(1-ft/wt);W<=Math.max(0,Ct)&&(O=!0,B=ft%2===0?J:ut),ft>wt&&ft<=wt+2&&W<.8&&(O=!0,B=J)}}if(Z>G){const E=this.getVegetationBlock(p,Z,u,G,yt,kt);E.exists&&(O=!0,B=E.color)}if(!O)continue;c.position.set(p*this.tileSize,Z*this.tileSize,u*this.tileSize),c.updateMatrix(),n.setMatrixAt(a,c.matrix),l.setHex(B);const Dt=`${p},${Z},${u}`;if(this.blockHealth.has(Dt)){const wt=.3+.7*(this.blockHealth.get(Dt)/3);l.multiplyScalar(wt)}n.setColorAt(a,l),a++}const ne=`${p},${u}`;if(this.placedBlocks.has(ne)){const Z=this.placedBlocks.get(ne);for(const[O,B]of Z){if(this.destroyedBlocks.has(`${p},${O},${u}`))continue;c.position.set(p*this.tileSize,O*this.tileSize,u*this.tileSize),c.updateMatrix(),n.setMatrixAt(a,c.matrix),l.setHex(B);const Dt=`${p},${O},${u}`;if(this.blockHealth.has(Dt)){const wt=.3+.7*(this.blockHealth.get(Dt)/3);l.multiplyScalar(wt)}n.setColorAt(a,l),a++}}}n.count=a,n.instanceMatrix.needsUpdate=!0,n.instanceColor&&(n.instanceColor.needsUpdate=!0),this.chunks.set(i,n),this.mesh.add(n)}update(t){const e=Math.floor(t.x/this.chunkSize),s=Math.floor(t.z/this.chunkSize),i=4;for(let o=-i;o<=i;o++)for(let n=-i;n<=i;n++){const c=this.getChunkKey(e+o,s+n);this.chunks.has(c)||this.generateChunk(e+o,s+n)}}getHeight(t,e,s=30){if(!this.getIslandData(t,e).isIsland)return-1/0;const o=this.getTreeHeight(t,e);if(o>0)return 30+o;for(const n of this.islandCenters){const c=t-(n.x-30),a=e-n.z,l=Math.sqrt(c*c+a*a),d=12;if(l<d){const g=l/d;return 30-Math.floor(4*(1-g*g))}const f=n.x,p=n.z,u=t-f,y=e-p;let w=Math.sqrt(u*u+y*y);const x=Math.floor(71-2*w);if(w<=5)return w>3.5?y>0&&Math.abs(u)<1.8?30:Math.max(58,x):30;if(w<=6.5&&x>30)return x}return 30}findSpawnPoint(){return new L(150,32,150)}getIslandData(t,e){for(const i of this.islandCenters){const o=t-i.x,n=e-i.z,c=Math.sqrt(o*o+n*n);if(c<55)return{isIsland:!0,center:i,dist:c}}return{isIsland:!1}}getTreeHeight(t,e){const s=Math.floor(t),i=Math.floor(e),o=this.getIslandData(s,i);if(!o.isIsland)return 0;const n=o.center,c=o.dist,a=n.x,l=n.z,d=s-a,f=i-l;let p=Math.sqrt(d*d+f*f);const u=p<=7,y=s-(n.x-30),w=i-n.z,g=Math.sqrt(y*y+w*w)<12,k=s-n.x,I=i-n.z,M=k<-30&&Math.abs(I)<3;if(!u&&!g&&!M&&c>10&&p>8){if(n.type==="ice"){const T=Math.floor(s/12),C=Math.floor(i/12),F=this.hash(T,C),K=this.hash(T+99,C+88),G=Math.floor((F-.5)*4),Y=Math.floor((K-.5)*4),q=T*12+6+G,H=C*12+6+Y;if(s===q&&i===H){const R=this.hash(T*2,C*2);if(R>=.4){const z=q-n.x,P=H-n.z,tt=Math.sqrt(z*z+P*P);if(tt<15||tt>42||Math.abs(z)<6&&P<-2&&P>-50)return 0;const j=q-(n.x-30),_=H-n.z;if(Math.sqrt(j*j+_*_)<15)return 0;const Q=q-n.x,$=H-n.z;return Q<-25&&Math.abs($)<6?0:10+Math.floor(R*5)}}return 0}if(n.type==="volcanic"){const T=Math.floor(s/14),C=Math.floor(i/14),F=this.hash(T,C),K=this.hash(T+123,C+456),G=Math.floor((F-.5)*6),Y=Math.floor((K-.5)*6),q=T*14+7+G,H=C*14+7+Y;if(s===q&&i===H){const R=this.hash(T*3,C*3);if(R>=.5){const z=q-n.x,P=H-n.z,tt=Math.sqrt(z*z+P*P);if(tt<15||tt>42||Math.abs(z)<6&&P>2&&P<50)return 0;const j=q-(n.x-30),_=H-n.z;if(Math.sqrt(j*j+_*_)<15)return 0;const Q=q-n.x,$=H-n.z;return Q<-25&&Math.abs($)<6?0:12+Math.floor(R*4)}}return 0}if(this.noise2D(s*.3,i*.3)>.6&&s%3===0&&i%3===0){const D=Math.abs(Math.sin(s*12.9898+i*78.233));return 4+Math.floor(D*3)}}return 0}getBlock(t,e,s){const i=Math.floor(t),o=Math.floor(e),n=Math.floor(s),c=`${i},${o},${n}`;if(this.destroyedBlocks.has(c))return!1;const a=`${i},${n}`;if(this.placedBlocks.has(a)&&this.placedBlocks.get(a).has(o))return!0;const l=this.getIslandData(i,n);if(!l.isIsland)return!1;const d=l.center,f=30;if(o<=f){const T=i-(d.x-30),C=n-d.z,F=Math.sqrt(T*T+C*C);if(F<12){const H=F/12,R=Math.floor(4*(1-H*H)),z=f-R;return o<=z}const K=i-d.x,G=n-d.z;return!(K<-30&&Math.abs(G)<3&&K<-48&&K>-55)}const p=d.x,u=d.z,y=i-p,w=n-u;let x=Math.sqrt(y*y+w*w);const g=4.5,k=7,M=k*4,S=f+M;if(o>f)if(o<=S){const T=o-f,F=T%k===0||T%k===k-1?g+.5:g;if(x<=F&&x>F-1.5){const K=d.type==="ice"?-1:1;return T<5&&w*K>0&&Math.abs(y)<1.5?T>3:!0}}else{const T=o-S,C=g+2-T*.5;if(x<=C&&C>=0)return!0}const D=this.getTreeHeight(i,n);return D>0&&o<=30+D}raycast(t,e,s){const i=t.clone();let o=0,n=Math.floor(i.x),c=Math.floor(i.y),a=Math.floor(i.z);const l=Math.sign(e.x),d=Math.sign(e.y),f=Math.sign(e.z),p=l!==0?Math.abs(1/e.x):1/0,u=d!==0?Math.abs(1/e.y):1/0,y=f!==0?Math.abs(1/e.z):1/0,w=l>0?n+1-i.x:i.x-n,x=d>0?c+1-i.y:i.y-c,g=f>0?a+1-i.z:i.z-a;let k=l!==0?w*p:1/0,I=d!==0?x*u:1/0,M=f!==0?g*y:1/0,S=new L;for(;o<s;){if(this.getBlock(n,c,a))return{point:new L(i.x+e.x*o,i.y+e.y*o,i.z+e.z*o),normal:S,block:{x:n,y:c,z:a}};k<I?k<M?(n+=l,o=k,k+=p,S.set(-l,0,0)):(a+=f,o=M,M+=y,S.set(0,0,-f)):I<M?(c+=d,o=I,I+=u,S.set(0,-d,0)):(a+=f,o=M,M+=y,S.set(0,0,-f))}return null}addBlock(t,e,s,i){const o=Math.floor(t),n=Math.floor(e),c=Math.floor(s),a=`${o},${c}`;this.placedBlocks.has(a)||this.placedBlocks.set(a,new Map),this.placedBlocks.get(a).set(n,i);const d=Math.floor(o/this.chunkSize),f=Math.floor(c/this.chunkSize);this.generateChunk(d,f,!0)}damageBlock(t,e,s,i=1){const o=Math.floor(t),n=Math.floor(e),c=Math.floor(s),a=`${o},${n},${c}`;if(n<=30||this.destroyedBlocks.has(a))return!1;let l=3;if(this.blockHealth.has(a)&&(l=this.blockHealth.get(a)),l-=i,l<=0)return this.removeBlock(t,e,s),this.blockHealth.delete(a),!0;{this.blockHealth.set(a,l);const d=Math.floor(o/this.chunkSize),f=Math.floor(c/this.chunkSize);return this.generateChunk(d,f,!0),!1}}removeBlock(t,e,s){const i=Math.floor(t),o=Math.floor(e),n=Math.floor(s),c=`${i},${o},${n}`,a=`${i},${n}`;if(this.placedBlocks.has(a)){const f=this.placedBlocks.get(a);if(f.has(o)){f.delete(o),f.size===0&&this.placedBlocks.delete(a);const p=Math.floor(i/this.chunkSize),u=Math.floor(n/this.chunkSize);this.generateChunk(p,u,!0);return}}if(o<=30||this.destroyedBlocks.has(c))return;this.destroyedBlocks.add(c);const l=Math.floor(i/this.chunkSize),d=Math.floor(n/this.chunkSize);this.generateChunk(l,d,!0)}getMapColor(t,e){const s=this.getIslandData(t,e);if(!s.isIsland)return"#000044";const i=s.center,o=i.x,n=i.z,c=t-o,a=e-n;if(c*c+a*a<=49)return"#555555";const d=t-(i.x-30),f=e-i.z;if(d*d+f*f<144)return"#4444FF";const p=t-i.x,u=e-i.z;return p<-30&&Math.abs(u)<3?"#4444FF":i.type==="ice"?"#FFFFFF":i.type==="arcane"?"#4B0082":i.type==="volcanic"?"#222222":"#5C9E46"}hash(t,e){let s=Math.sin(t*12.9898+e*78.233)*43758.5453123;return s-Math.floor(s)}getVegetationBlock(t,e,s,i,o,n){const c=this.getIslandData(t,s);if(!c.isIsland)return{exists:!1};const a=c.center.type;if(a==="ice")return this.getIceTreeBlock(t,e,s,i);if(a==="volcanic")return this.getFireTreeBlock(t,e,s,i);const l=this.getTreeHeight(t,s);if(l>0){const d=e-i;if(d>0){if(d<=l)return{exists:!0,color:o};if(d<=l+2)return{exists:!0,color:n}}}return{exists:!1}}getTreeInGrid(t,e){const i=this.hash(t,e),o=this.hash(t+123,e+456),n=Math.floor((i-.5)*6),c=Math.floor((o-.5)*6),a=t*14+7+n,l=e*14+7+c,d=this.hash(t*3,e*3);if(d<.5)return{exists:!1};const f=this.getIslandData(a,l);if(!f.isIsland||f.center.type!=="volcanic")return{exists:!1};const p=f.center,u=a-p.x,y=l-p.z,w=Math.sqrt(u*u+y*y);if(w<15)return{exists:!1};if(w>42)return{exists:!1};if(Math.abs(u)<6&&y>2&&y<50)return{exists:!1};const x=a-(p.x-30),g=l-p.z;if(Math.sqrt(x*x+g*g)<15)return{exists:!1};const k=a-p.x,I=l-p.z;if(k<-25&&Math.abs(I)<6)return{exists:!1};const M=12+Math.floor(d*4);return{exists:!0,x:a,z:l,height:M}}getFireTreeBlock(t,e,s,i){const n=Math.floor(t/14),c=Math.floor(s/14),a=this.getTreeInGrid(n,c);if(!a.exists)return{exists:!1};const l=a.x,d=a.z,f=a.height,p=e-i;if(p>f&&p<f+4&&this.hash(t,e*s*1.1)>.98){const I=t-l,M=s-d;if(Math.abs(I)<=2&&Math.abs(M)<=2)return{exists:!0,color:16755200}}if(p<0||p>f)return{exists:!1};const u=t-l,y=s-d,w=Math.abs(u),x=Math.abs(y);if(p===0&&(w<=2&&x===0||x<=2&&w===0||w===1&&x===1))return{exists:!0,color:3346688};if(p===1&&(w<=1&&x===0||x<=1&&w===0))return{exists:!0,color:3346688};if(w===0&&x===0&&p<f/2)return{exists:!0,color:3346688};const g=4;if(p>=g){const k=f-g,I=(p-g)/k;let M=0;if(I<.2||I<.5?M=2:I<.8?M=1:M=0,w+x<=M)return{exists:!0,color:16729344};if(w+x<=M+1&&this.hash(t,e*s)>.3)return{exists:!0,color:16753920}}return{exists:!1}}getIceTreeBlock(t,e,s,i){const n=Math.floor(t/12),c=Math.floor(s/12),a=this.hash(n,c),l=this.hash(n+99,c+88),d=Math.floor((a-.5)*4),f=Math.floor((l-.5)*4),p=n*12+6+d,u=c*12+6+f,y=this.hash(n,c);if(y<.4)return{exists:!1};const w=this.getIslandData(p,u);if(!w.isIsland||w.center.type!=="ice")return{exists:!1};const x=w.center,g=p-x.x,k=u-x.z,I=Math.sqrt(g*g+k*k);if(I<15)return{exists:!1};if(I>42)return{exists:!1};if(Math.abs(g)<6&&k<-2&&k>-50)return{exists:!1};const M=p-(x.x-30),S=u-x.z;if(Math.sqrt(M*M+S*S)<15)return{exists:!1};const D=p-x.x,T=u-x.z;if(D<-25&&Math.abs(T)<6)return{exists:!1};const C=10+Math.floor(y*5),F=e-i;if(F<0||F>C)return{exists:!1};const K=t-p,G=s-u,Y=Math.abs(K),q=Math.abs(G),H=Math.max(Y,q);if(H===0&&F<C/2)return{exists:!0,color:3037832};let R=-1;if(F>=C-2?R=0:F>=C-4?R=1:F>=C-7?R=2:F>=C-10&&(R=3),F<3&&(R=-1),R>=0&&H<=R){const z=this.hash(t,e*s);return{exists:!0,color:z>.6?10875635:z>.3?8255999:5292256}}return{exists:!1}}getTerrainType(t,e,s){const i=Math.floor(t),o=Math.floor(e),n=Math.floor(s),c=this.getIslandData(i,n);if(!c.isIsland)return"void";const a=c.center,l=a.type,d=i-(a.x-30),f=n-a.z;if(Math.sqrt(d*d+f*f)<12&&o>=26&&o<=30)return l==="volcanic"?"lava":l==="ice"?"ice":"water";const u=i-a.x,y=n-a.z,w=u<-30&&Math.abs(y)<3;if(w&&u<-48&&u>-55)return!1;if(w&&o>=28&&o<=30)return l==="volcanic"?"lava":l==="ice"?"ice":"water";if(l==="ice"){const g=i-a.x,k=n-a.z;return Math.abs(g)<2.5&&k<-4&&k>-48&&o===30?"ice":"snow"}if(l==="volcanic"){const g=i-a.x,k=n-a.z;if(Math.abs(g)<2.5&&k>4&&k<48&&o===30)return"ground"}return"ground"}getTreeInGrid(t,e){const i=this.hash(t,e),o=this.hash(t+123,e+456),n=Math.floor((i-.5)*6),c=Math.floor((o-.5)*6),a=t*14+7+n,l=e*14+7+c,d=this.hash(t*3,e*3);if(d<.5)return{exists:!1};const f=this.getIslandData(a,l);if(!f.isIsland||f.center.type!=="volcanic")return{exists:!1};const p=f.center,u=a-p.x,y=l-p.z,w=Math.sqrt(u*u+y*y);if(w<15)return{exists:!1};if(w>42)return{exists:!1};if(Math.abs(u)<6&&y>2&&y<50)return{exists:!1};const x=a-(p.x-30),g=l-p.z;if(Math.sqrt(x*x+g*g)<15)return{exists:!1};const k=a-p.x,I=l-p.z;if(k<-25&&Math.abs(I)<6)return{exists:!1};const M=12+Math.floor(d*4);return{exists:!0,x:a,z:l,height:M}}}class Ne{constructor(){this.keys={},this.mouseButtons={},this.mouse={x:0,y:0,movementX:0,movementY:0},this.isLocked=!1,window.addEventListener("keydown",t=>this.keys[t.code]=!0),window.addEventListener("keyup",t=>this.keys[t.code]=!1),document.addEventListener("mousedown",t=>{this.isLocked&&(this.mouseButtons[t.button]=!0)}),document.addEventListener("mouseup",t=>this.mouseButtons[t.button]=!1),document.addEventListener("mousemove",t=>{this.isLocked&&(this.mouse.movementX=t.movementX,this.mouse.movementY=t.movementY)}),document.addEventListener("click",t=>{!this.isLocked&&t.target.tagName==="CANVAS"&&document.body.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{this.isLocked=document.pointerLockElement===document.body}),document.addEventListener("contextmenu",t=>(t.preventDefault(),!1))}isKeyDown(t){return!!this.keys[t]}isMouseButtonDown(t){return!!this.mouseButtons[t]}getMouseMovement(){const t={x:this.mouse.movementX,y:this.mouse.movementY};return this.mouse.movementX=0,this.mouse.movementY=0,t}}class Jt{constructor(t,e,s,i,o,n="normal",c=1){this.scene=t,this.particleSystem=i,this.soundManager=o,this.type=n,this.velocity=s.clone().normalize().multiplyScalar(60),this.isAlive=!0,this.lifeTime=1.5,this.damage=10*c;let a=65535,l=.3;this.type==="fireball"?(a=16729088,l=.6,this.damage=30*c,this.lifeTime=3):this.type==="icebolt"&&(a=65535,l=.6,this.damage=30*c,this.lifeTime=3);const d=new ke(l,8,8),f=new se({color:a});this.mesh=new h(d,f),this.mesh.position.copy(e),this.light=new Kt(a,1,10),this.mesh.add(this.light),this.scene.add(this.mesh)}update(t,e,s){if(!this.isAlive)return;if(this.lifeTime-=t,this.lifeTime<=0){this.destroy();return}let i=65535;this.type==="fireball"?i=16729088:this.type==="icebolt"&&(i=65535),this.particleSystem.emit(this.mesh.position,i,1,.5,.2);const o=this.velocity.clone().multiplyScalar(t),n=o.length(),c=o.clone().normalize();if(s)for(const[l,d]of s){const f=this.mesh.position.distanceTo(d.mesh.position),p=this.type==="fireball"||this.type==="icebolt"?3:1.5;if(f<p){this.onHitPlayer(l);return}}const a=e.raycast(this.mesh.position,c,n);if(a){if(this.mesh.position.copy(a.point),this.type==="fireball"||this.type==="icebolt"){const d=Math.floor(a.point.x),f=Math.floor(a.point.y),p=Math.floor(a.point.z);for(let u=-3;u<=3;u++)for(let y=-3;y<=3;y++)for(let w=-3;w<=3;w++)u*u+y*y+w*w<=9&&e.damageBlock(d+u,f+y,p+w,10)&&this.onBlockDestroyedCallback&&this.onBlockDestroyedCallback(d+u,f+y,p+w)}else a.block&&e.damageBlock(a.block.x,a.block.y,a.block.z,1)&&this.onBlockDestroyedCallback&&this.onBlockDestroyedCallback(a.block.x,a.block.y,a.block.z);this.onHit();return}this.mesh.position.add(o)}onHitPlayer(t){this.soundManager&&this.soundManager.playHit(),this.particleSystem&&this.particleSystem.emit(this.mesh.position,16711680,20),this.onPlayerHitCallback&&this.onPlayerHitCallback(t,this.damage),this.destroy()}onHit(){this.soundManager&&(this.type==="fireball"?this.soundManager.playExplosion():this.soundManager.playImpact()),this.particleSystem&&this.particleSystem.emit(this.mesh.position,65535,15),this.destroy()}destroy(){this.isAlive=!1,this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.light.dispose()}}class Je{constructor(t,e,s,i,o,n,c,a="witch"){this.scene=t,this.camera=e,this.world=s,this.particleSystem=o,this.soundManager=n,this.networkManager=c,this.characterClass=a,this.input=new Ne,this.isDead=!1,this.spawnPoint=i?i.clone():new L(10,20,10),this.networkTimer=0,this.networkInterval=.05;const l=this.characterClass==="warlock"?this.createWarlockMesh():this.createWitchMesh();this.mesh=l.mesh,this.mesh.position.set(10,20,10),this.wand=this.createWand(),l.leftArm.add(this.wand),this.wand.position.set(0,-.4,.2),this.wand.rotation.x=Math.PI/2,this.broom=this.createBroom(),this.broom.visible=!1,this.characterClass!=="warlock"&&this.mesh.add(this.broom),this.broom.position.set(0,.5,0),i?this.mesh.position.copy(i):this.mesh.position.set(10,20,10),this.mesh.traverse(p=>p.castShadow=!0),this.scene.add(this.mesh),this.velocity=new L,this.onGround=!1,this.gravity=-30,this.speed=10,this.flySpeed=25,this.jumpForce=10,this.isFlying=!1,this.flyTogglePressed=!1,this.projectiles=[],this.lastShotTime=0,this.shootCooldown=.3,this.abilityCooldown=5,this.lastAbilityTime=0,this.dashCooldown=3,this.lastDashTime=0,this.team="spectator",this.maxMana=100,this.mana=100,this.manaRegen=5,this.abilityCost=40,this.isBuildMode=!1,this.buildTogglePressed=!1,this.buildCooldown=.2,this.lastBuildTime=0;const d=new m(1.01,1.01,1.01),f=new se({color:65280,wireframe:!0,transparent:!0,opacity:.5});this.ghostBlock=new h(d,f),this.scene.add(this.ghostBlock),this.ghostBlock.visible=!1,this.physicsPosition=this.mesh.position.clone(),this.cameraOffset=new L(0,2,5),this.cameraRotation=new Ce(0,0,0,"YXZ"),this.currentBiome="ice",this.checkBiomeTimer=0,this.speedBuffTimer=0,this.damageBuffTimer=0,this.shield=0,this.lavaDamageTimer=0,this.footstepTimer=0}setSpawnPoint(t){this.spawnPoint.copy(t)}get position(){return this.mesh.position}get rotation(){return this.cameraRotation}setCharacterClass(t){if(this.characterClass===t)return;this.characterClass=t,this.scene.remove(this.mesh);const e=this.characterClass==="warlock"?this.createWarlockMesh():this.createWitchMesh();this.mesh=e.mesh,this.mesh.position.copy(this.physicsPosition),this.mesh.rotation.y=this.cameraRotation.y,e.leftArm.add(this.wand),this.wand.position.set(0,-.4,.2),this.wand.rotation.x=Math.PI/2,this.characterClass!=="warlock"?(this.mesh.add(this.broom),this.broom.position.set(0,.5,0),this.broom.visible=this.isFlying):this.broom.visible=!1,this.mesh.traverse(s=>s.castShadow=!0),this.scene.add(this.mesh)}update(t,e){if(this.isDead)return;this.speedBuffTimer>0&&(this.speedBuffTimer-=t),this.damageBuffTimer>0&&(this.damageBuffTimer-=t),this.mana<this.maxMana&&(this.mana+=this.manaRegen*t,this.mana>this.maxMana&&(this.mana=this.maxMana),this.updateManaUI()),this.networkTimer+=t,this.networkTimer>=this.networkInterval&&(this.networkTimer=0,this.networkManager&&this.networkManager.sendMove(this.physicsPosition,this.cameraRotation,this.currentBiome));for(let D=this.projectiles.length-1;D>=0;D--){const T=this.projectiles[D];T.update(t,this.world,e),T.isAlive||this.projectiles.splice(D,1)}this.input.isKeyDown("KeyF")?this.flyTogglePressed||(this.isFlying=!this.isFlying,this.flyTogglePressed=!0,this.characterClass!=="warlock"&&(this.broom.visible=this.isFlying),this.isFlying?(this.velocity.y=0,this.mesh.rotation.x=.3,this.mesh.position.y+=1):this.mesh.rotation.x=0):this.flyTogglePressed=!1,this.input.isKeyDown("KeyB")?this.buildTogglePressed||(this.isBuildMode=!this.isBuildMode,this.buildTogglePressed=!0,this.ghostBlock.visible=this.isBuildMode):this.buildTogglePressed=!1,this.isBuildMode?this.updateBuildMode(t):(this.ghostBlock.visible=!1,this.lastShotTime+=t,this.input.isMouseButtonDown(0)&&this.lastShotTime>=this.shootCooldown&&(this.shoot(),this.lastShotTime=0),this.input.isMouseButtonDown(2)&&this.useAbility());const s=this.input.getMouseMovement();if(this.cameraRotation.y-=s.x*.002,this.cameraRotation.x-=s.y*.002,this.cameraRotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.cameraRotation.x)),this.input.isKeyDown("ShiftLeft")&&!this.isFlying){const D=performance.now()/1e3;D-this.lastDashTime>this.dashCooldown&&(this.performDash(),this.lastDashTime=D)}const i=new L(0,0,-1).applyAxisAngle(new L(0,1,0),this.cameraRotation.y),o=new L(1,0,0).applyAxisAngle(new L(0,1,0),this.cameraRotation.y),n=new L;this.input.isKeyDown("KeyW")&&n.add(i),this.input.isKeyDown("KeyS")&&n.sub(i),this.input.isKeyDown("KeyD")&&n.add(o),this.input.isKeyDown("KeyA")&&n.sub(o),n.length()>0&&n.normalize();let c=this.isFlying?this.flySpeed:this.speed;this.speedBuffTimer>0&&(c*=2);const a=n.x*c,l=n.z*c,d=this.world.getTerrainType(this.physicsPosition.x,this.physicsPosition.y-.5,this.physicsPosition.z);let f=20;d==="ice"&&!this.isFlying&&this.onGround&&(f=1);const p=1-Math.exp(-f*t);this.velocity.x+=(a-this.velocity.x)*p,this.velocity.z+=(l-this.velocity.z)*p,this.onGround&&!this.isFlying&&(Math.abs(this.velocity.x)>.1||Math.abs(this.velocity.z)>.1)?(this.footstepTimer+=t,this.footstepTimer>.4&&(this.soundManager.playFootstep(),this.footstepTimer=0)):this.footstepTimer=.4,d==="lava"?(this.lavaDamageTimer+=t,this.lavaDamageTimer>.5&&(this.lavaDamageTimer=0,this.networkManager&&this.networkManager.playerId&&(this.networkManager.sendHit(this.networkManager.playerId,5),this.particleSystem.emit(this.position,16729088,10)))):this.lavaDamageTimer=0,this.isFlying?this.input.isKeyDown("Space")?this.velocity.y=c*.5:this.input.isKeyDown("ShiftLeft")||this.input.isKeyDown("KeyC")?this.velocity.y=-c*.5:this.velocity.y=0:(this.onGround&&this.input.isKeyDown("Space")&&(this.velocity.y=this.jumpForce,this.onGround=!1),this.velocity.y+=this.gravity*t),this.wandParticles&&(this.wandParticles.rotation.y+=t*2,this.wandParticles.rotation.z+=t*1);const u=this.physicsPosition.clone();this.physicsPosition.x+=this.velocity.x*t,this.checkCollision(this.physicsPosition)&&(this.physicsPosition.x=u.x,this.velocity.x=0),this.physicsPosition.z+=this.velocity.z*t,this.checkCollision(this.physicsPosition)&&(this.physicsPosition.z=u.z,this.velocity.z=0),this.physicsPosition.y+=this.velocity.y*t,this.checkCollision(this.physicsPosition)?(this.velocity.y<0?(this.onGround=!0,this.physicsPosition.y=u.y):this.physicsPosition.y=u.y,this.velocity.y=0):this.onGround=!1,this.physicsPosition.y<-50&&this.onDeath(),this.mesh.position.x=this.physicsPosition.x,this.mesh.position.z=this.physicsPosition.z,this.mesh.position.y=Pt.lerp(this.mesh.position.y,this.physicsPosition.y,10*t);const y=this.mesh.position.clone().add(new L(0,1.5,0)),w=new L(1.5,1,5);w.applyEuler(this.cameraRotation);const x=y.clone().add(w),g=x.clone().sub(y).normalize(),k=y.distanceTo(x),I=this.world.raycast(y,g,k);if(I){const D=y.distanceTo(I.point),T=Math.max(.5,D-.2),C=y.clone().add(g.multiplyScalar(T));this.camera.position.copy(C)}else this.camera.position.copy(x);const M=new L(0,0,-1);M.applyEuler(this.cameraRotation);const S=this.camera.position.clone().add(M.multiplyScalar(20));if(this.camera.lookAt(S),this.mesh.rotation.y=this.cameraRotation.y,this.isFlying){let T=.3,C=0;if(this.input.isKeyDown("KeyW")&&(T=.8),this.input.isKeyDown("KeyS")&&(T=-.2),this.input.isKeyDown("KeyA")&&(C=.5),this.input.isKeyDown("KeyD")&&(C=-.5),this.mesh.rotation.x=Pt.lerp(this.mesh.rotation.x,T,t*5),this.mesh.rotation.z=Pt.lerp(this.mesh.rotation.z,C,t*5),this.particleSystem){const F=new L(0,0,1.4);F.applyMatrix4(this.broom.matrixWorld),this.particleSystem.emit(F,15645525,2)}}else this.mesh.rotation.x=Pt.lerp(this.mesh.rotation.x,0,t*10),this.mesh.rotation.z=Pt.lerp(this.mesh.rotation.z,0,t*10)}setTeam(t){this.team=t}performDash(){const t=new L(0,0,-1).applyAxisAngle(new L(0,1,0),this.rotation.y);if(this.velocity.add(t.multiplyScalar(40)),this.soundManager&&this.soundManager.playJump(),this.particleSystem)for(let e=0;e<10;e++)this.particleSystem.emit(this.mesh.position.clone(),16777215,5)}updateManaUI(){const t=document.getElementById("mana-bar"),e=document.getElementById("mana-text");t&&e&&(t.style.width=`${this.mana/this.maxMana*100}%`,e.textContent=`${Math.floor(this.mana)} / ${this.maxMana}`)}shoot(){const t=this.damageBuffTimer>0?2:1,e=new Jt(this.scene,this.wand.getWorldPosition(new L),this.camera.getWorldDirection(new L),this.particleSystem,this.soundManager,"normal",t);e.onPlayerHitCallback=(s,i)=>{this.networkManager&&this.networkManager.sendHit(s,i)},e.onBlockDestroyedCallback=(s,i,o)=>{this.networkManager&&this.networkManager.sendBlockUpdate(s,i,o,0)},this.projectiles.push(e),this.soundManager.playShoot()}useAbility(){const t=performance.now();if(t-this.lastAbilityTime<500||this.mana<this.abilityCost)return;this.lastAbilityTime=t;const e=this.damageBuffTimer>0?2:1;if(this.team==="red"){const s=new Jt(this.scene,this.wand.getWorldPosition(new L),this.camera.getWorldDirection(new L),this.particleSystem,this.soundManager,"fireball",e);s.onPlayerHitCallback=(i,o)=>{this.networkManager&&this.networkManager.sendHit(i,o)},s.onBlockDestroyedCallback=(i,o,n)=>{this.networkManager&&this.networkManager.sendBlockUpdate(i,o,n,0)},this.projectiles.push(s),this.mana-=this.abilityCost,this.updateManaUI()}else if(this.team==="blue"){const s=new Jt(this.scene,this.wand.getWorldPosition(new L),this.camera.getWorldDirection(new L),this.particleSystem,this.soundManager,"icebolt",e);s.onPlayerHitCallback=(i,o)=>{this.networkManager&&this.networkManager.sendHit(i,o)},s.onBlockDestroyedCallback=(i,o,n)=>{this.networkManager&&this.networkManager.sendBlockUpdate(i,o,n,0)},this.projectiles.push(s),this.mana-=this.abilityCost,this.updateManaUI()}}applyPotion(t){console.log("Applied potion:",t),t==="speed"?this.speedBuffTimer=10:t==="shield"?(this.shield+=50,this.networkManager&&this.networkManager.onHealthUpdate(this.health+this.shield)):t==="berserk"&&(this.damageBuffTimer=10)}createWand(){const t=new et,e=new Ee(.02,.03,.8,8),s=new b({color:6045747}),i=new h(e,s);t.add(i);const o=new Ge(.06),n=new b({color:65535,emissive:35071,emissiveIntensity:.5,transparent:!0,opacity:.9}),c=new h(o,n);return c.position.y=.4,t.add(c),this.wandParticles=c,t}createBroom(){const t=new et,e=new b({color:6045747}),s=new b({color:4073251}),i=new b({color:13934615}),o=new m(.05,.05,2),n=new h(o,e);n.position.z=-.5,t.add(n);const c=new m(.07,.07,.1),a=new h(c,s);a.position.z=.55,t.add(a);const l=new et;l.position.z=.6;const d=new h(new m(.15,.15,.4),i);d.position.z=.2,l.add(d);const f=new h(new m(.25,.1,.3),i);f.position.z=.2,l.add(f);const p=new h(new m(.1,.25,.3),i);return p.position.z=.2,l.add(p),t.add(l),t.position.set(0,.6,0),t}createWitchMesh(){const t=new et,e=new et;t.add(e),e.rotation.y=Math.PI;const s=16764074,i=4915330,o=3342438,n=16711680,c=16753920,a=1118481,l=new m(.5,.8,.4),d=new b({color:i}),f=new h(l,d);f.position.y=.9,e.add(f);const p=new m(.6,.6,.5),u=new h(p,d);u.position.y=.3,e.add(u);const y=new m(.35,.35,.35),w=new b({color:s}),x=new h(y,w);x.position.y=1.5,e.add(x);const g=new b({color:c}),k=new h(new m(.45,.5,.15),g);k.position.set(0,1.5,-.2),e.add(k);const I=new h(new m(.1,.4,.4),g);I.position.set(-.2,1.5,0),e.add(I);const M=new h(new m(.1,.4,.4),g);M.position.set(.2,1.5,0),e.add(M);const S=new et,D=new b({color:o}),T=new b({color:n}),C=new h(new m(.8,.1,.8),D);C.position.y=1.7,S.add(C);const F=new h(new m(.5,.3,.5),D);F.position.y=1.9,S.add(F);const K=new h(new m(.45,.15,.45),T);K.position.y=2.1,S.add(K);const G=new h(new m(.35,.3,.35),D);G.position.y=2.3,S.add(G);const Y=new h(new m(.2,.3,.2),D);Y.position.y=2.6,S.add(Y);const q=new h(new m(.15,.2,.15),D);q.position.set(.1,2.8,0),q.rotation.z=-.2,S.add(q),e.add(S);const H=new m(.15,.5,.15),R=new b({color:i}),z=new h(H,R);z.position.set(-.35,1,0),z.rotation.z=0,e.add(z);const P=new h(H,R);P.position.set(.35,1,0),P.rotation.z=0,e.add(P);const tt=new m(.12,.12,.12),j=new b({color:s}),_=new h(tt,j);_.position.set(0,-.3,0),z.add(_);const Q=new h(tt,j);Q.position.set(0,-.3,0),P.add(Q);const $=new m(.15,.4,.15),X=new b({color:a}),W=new h($,X);W.position.set(-.15,.2,0),e.add(W);const V=new h($,X);V.position.set(.15,.2,0),e.add(V);const ot=new m(.05,.05,.05),N=new b({color:0}),U=new h(ot,N);U.position.set(-.1,1.55,.18),e.add(U);const ct=new h(ot,N);return ct.position.set(.1,1.55,.18),e.add(ct),{mesh:t,rightArm:P,leftArm:z,rightHand:Q}}createWarlockMesh(){const t=new et,e=new et;t.add(e),e.rotation.y=Math.PI;const s=16764074,i=4915330,o=4915330,n=16711680,c=0,a=0,l=9127187,d=16766720,f=new et,p=new m(.1,.1,2),u=new b({color:l}),y=new h(p,u);y.position.set(0,.6,.2),y.rotation.x=-.1,f.add(y);const w=new m(.3,.3,.6),x=new b({color:d}),g=new h(w,x);g.position.set(0,.7,-.8),g.rotation.x=-.1,f.add(g),e.add(f);const k=new m(.45,.7,.35),I=new b({color:i}),M=new h(k,I);M.position.y=1,e.add(M);const S=new m(.5,.4,.5),D=new h(S,I);D.position.y=.7,e.add(D);const T=new m(.35,.35,.35),C=new b({color:s}),F=new h(T,C);F.position.y=1.55,e.add(F);const K=new m(.08,.08,.08),G=new h(K,C);G.position.set(0,1.5,.2),e.add(G);const Y=new b({color:c}),q=new h(new m(.4,.5,.15),Y);q.position.set(0,1.5,-.2),e.add(q);const H=new h(new m(.1,.4,.4),Y);H.position.set(-.2,1.5,0),e.add(H);const R=new h(new m(.1,.4,.4),Y);R.position.set(.2,1.5,0),e.add(R);const z=new et,P=new b({color:o}),tt=new b({color:n}),j=new h(new m(.7,.05,.7),P);j.position.y=1.75,z.add(j);const _=new h(new m(.4,.1,.4),tt);_.position.y=1.82,z.add(_);const Q=new h(new m(.35,.25,.35),P);Q.position.y=2,z.add(Q);const $=new h(new m(.25,.25,.25),P);$.position.y=2.25,z.add($);const X=new h(new m(.15,.25,.15),P);X.position.y=2.5,z.add(X);const W=new h(new m(.1,.2,.1),P);W.position.set(.05,2.7,-.05),W.rotation.z=-.2,W.rotation.x=-.2,z.add(W),e.add(z);const V=new m(.12,.45,.12),ot=new b({color:i}),N=new h(V,ot);N.position.set(-.3,1.1,.1),N.rotation.z=-.2,N.rotation.x=-.5,e.add(N);const U=new h(V,ot);U.position.set(.3,1.1,.1),U.rotation.z=.2,U.rotation.x=-.5,e.add(U);const ct=new m(.1,.1,.1),vt=new b({color:s}),at=new h(ct,vt);at.position.set(0,-.25,0),N.add(at);const lt=new h(ct,vt);lt.position.set(0,-.25,0),U.add(lt),new m(.13,.35,.13);const pt=new b({color:i}),Mt=new b({color:a}),st=new h(new m(.14,.35,.14),pt);st.position.set(-.2,.8,.1),st.rotation.x=-1,st.rotation.z=.2,e.add(st);const ht=new h(new m(.12,.3,.12),Mt);ht.position.set(0,-.25,.1),ht.rotation.x=1,st.add(ht);const J=new h(new m(.14,.35,.14),pt);J.position.set(.2,.8,.1),J.rotation.x=-1,J.rotation.z=-.2,e.add(J);const ut=new h(new m(.12,.3,.12),Mt);ut.position.set(0,-.25,.1),ut.rotation.x=1,J.add(ut);const yt=new m(.04,.04,.04),kt=new b({color:0}),xt=new h(yt,kt);xt.position.set(-.08,1.55,.18),e.add(xt);const dt=new h(yt,kt);return dt.position.set(.08,1.55,.18),e.add(dt),{mesh:t,rightArm:U,leftArm:N,rightHand:lt}}checkCollision(t){return!!(this.world.getBlock(Math.floor(t.x),Math.floor(t.y),Math.floor(t.z))||this.world.getBlock(Math.floor(t.x),Math.floor(t.y+1.5),Math.floor(t.z)))}onDeath(){this.isDead=!0,this.soundManager&&this.soundManager.playDeath&&this.soundManager.playDeath(),setTimeout(()=>{this.isDead=!1,this.mesh.position.copy(this.spawnPoint),this.physicsPosition.copy(this.spawnPoint),this.velocity.set(0,0,0),this.health=100,this.mana=100,this.updateManaUI(),this.networkManager&&this.networkManager.sendRespawn(this.spawnPoint)},3e3)}updateBuildMode(t){const e=new L(0,0,-1).applyQuaternion(this.camera.quaternion),s=this.camera.position.clone().add(e.multiplyScalar(3)),i=Math.floor(s.x),o=Math.floor(s.y),n=Math.floor(s.z);this.ghostBlock.position.set(i+.5,o+.5,n+.5),this.input.isMouseButtonDown(0)?performance.now()-this.lastBuildTime>this.buildCooldown*1e3&&(this.world.addBlock(i,o,n,5592405),this.lastBuildTime=performance.now(),this.networkManager&&this.networkManager.sendBlockUpdate(i,o,n,1)):this.input.isMouseButtonDown(2)&&performance.now()-this.lastBuildTime>this.buildCooldown*1e3&&(this.world.removeBlock(i,o,n),this.lastBuildTime=performance.now(),this.networkManager&&this.networkManager.sendBlockUpdate(i,o,n,0))}}class _e{constructor(t,e){this.world=t,this.player=e,this.canvas=document.getElementById("minimap"),this.ctx=this.canvas.getContext("2d"),this.size=200,this.zoom=1.5,this.visited=new Set,this.cellSize=4}update(){const t=this.player.position.x,e=this.player.position.z,s=60;for(let i=t-s;i<=t+s;i+=this.cellSize)for(let o=e-s;o<=e+s;o+=this.cellSize){const n=i-t,c=o-e;if(n*n+c*c<=s*s){const a=Math.floor(i/this.cellSize),l=Math.floor(o/this.cellSize);this.visited.add(`${a},${l}`)}}this.draw()}draw(){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.size/2,this.size/2,this.size/2,0,Math.PI*2),this.ctx.clip(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.size,this.size);const t=this.player.position.x,e=this.player.position.z,s=this.size*this.zoom/2,i=Math.floor((t-s)/this.cellSize)*this.cellSize,o=Math.floor((t+s)/this.cellSize)*this.cellSize,n=Math.floor((e-s)/this.cellSize)*this.cellSize,c=Math.floor((e+s)/this.cellSize)*this.cellSize;for(let d=i;d<=o;d+=this.cellSize)for(let f=n;f<=c;f+=this.cellSize){const p=Math.floor(d/this.cellSize),u=Math.floor(f/this.cellSize);if(this.visited.has(`${p},${u}`)){const y=this.world.getMapColor(d,f),w=this.size/2+(d-t)/this.zoom,x=this.size/2+(f-e)/this.zoom,g=this.cellSize/this.zoom+1;this.ctx.fillStyle=y,this.ctx.fillRect(w,x,g,g)}}this.ctx.fillStyle="white",this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(this.size/2,this.size/2,4,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke();const a=Math.sin(this.player.rotation.y),l=Math.cos(this.player.rotation.y);this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(this.size/2,this.size/2),this.ctx.lineTo(this.size/2-a*10,this.size/2-l*10),this.ctx.stroke(),this.ctx.restore()}}class Qe{constructor(t){this.scene=t,this.particles=[],this.geometry=new m(.2,.2,.2),this.material=new se({color:16777215})}emit(t,e,s=5,i=5,o=1,n=-10){for(let c=0;c<s;c++){const a=new h(this.geometry,this.material.clone());a.material.color.setHex(e),a.position.copy(t),a.position.x+=(Math.random()-.5)*.5,a.position.y+=(Math.random()-.5)*.5,a.position.z+=(Math.random()-.5)*.5;const l=new L(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize().multiplyScalar(i*Math.random());this.particles.push({mesh:a,velocity:l,life:o,maxLife:o,gravity:n}),this.scene.add(a)}}update(t){for(let e=this.particles.length-1;e>=0;e--){const s=this.particles[e];s.life-=t,s.mesh.position.add(s.velocity.clone().multiplyScalar(t)),s.velocity.y+=s.gravity*t;const i=s.life/s.maxLife;s.mesh.scale.setScalar(i),s.life<=0&&(this.scene.remove(s.mesh),s.mesh.material.dispose(),this.particles.splice(e,1))}}}class ts{constructor(t){this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.3,this.masterGain.connect(this.ctx.destination),this.windOsc=null,this.windGain=null,this.initWind()}initWind(){const t=2*this.ctx.sampleRate,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate),s=e.getChannelData(0);for(let o=0;o<t;o++){const n=Math.random()*2-1;s[o]=(i+.02*n)/1.02,i=s[o],s[o]*=3.5}var i=0;this.windNode=this.ctx.createBufferSource(),this.windNode.buffer=e,this.windNode.loop=!0,this.windFilter=this.ctx.createBiquadFilter(),this.windFilter.type="lowpass",this.windFilter.frequency.value=200,this.windGain=this.ctx.createGain(),this.windGain.gain.value=0,this.windNode.connect(this.windFilter),this.windFilter.connect(this.windGain),this.windGain.connect(this.masterGain),this.windNode.start()}updateWind(t){this.ctx.state==="suspended"&&this.ctx.resume();const e=Math.min(t/30,1);this.windGain.gain.setTargetAtTime(e*.5,this.ctx.currentTime,.1),this.windFilter.frequency.setTargetAtTime(200+e*800,this.ctx.currentTime,.1)}playShoot(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(880,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(110,this.ctx.currentTime+.1),e.gain.setValueAtTime(.3,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.1)}playExplosion(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.sampleRate*.5,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate),s=e.getChannelData(0);for(let c=0;c<t;c++)s[c]=Math.random()*2-1;const i=this.ctx.createBufferSource();i.buffer=e;const o=this.ctx.createBiquadFilter();o.type="lowpass",o.frequency.setValueAtTime(1e3,this.ctx.currentTime),o.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+.3);const n=this.ctx.createGain();n.gain.setValueAtTime(.5,this.ctx.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.3),i.connect(o),o.connect(n),n.connect(this.masterGain),i.start()}playHit(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(200,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.1),e.gain.setValueAtTime(.5,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.1)}playImpact(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.sampleRate*.1,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate),s=e.getChannelData(0);for(let n=0;n<t;n++)s[n]=Math.random()*2-1;const i=this.ctx.createBufferSource();i.buffer=e;const o=this.ctx.createGain();o.gain.setValueAtTime(.3,this.ctx.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),i.connect(o),o.connect(this.masterGain),i.start()}playPowerup(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(440,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(880,this.ctx.currentTime+.1),t.frequency.exponentialRampToValueAtTime(1760,this.ctx.currentTime+.3),e.gain.setValueAtTime(.3,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.3),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.3)}playFootstep(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.sampleRate*.05,e=this.ctx.createBuffer(1,t,this.ctx.sampleRate),s=e.getChannelData(0);for(let c=0;c<t;c++)s[c]=Math.random()*2-1;const i=this.ctx.createBufferSource();i.buffer=e;const o=this.ctx.createBiquadFilter();o.type="lowpass",o.frequency.value=800;const n=this.ctx.createGain();n.gain.setValueAtTime(.1,this.ctx.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.05),i.connect(o),o.connect(n),n.connect(this.masterGain),i.start()}playHitMarker(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(2e3,this.ctx.currentTime),e.gain.setValueAtTime(.1,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.1)}playDeath(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(200,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.5),e.gain.setValueAtTime(.5,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.5),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.5)}playJump(){this.ctx.state==="suspended"&&this.ctx.resume();const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="sine",t.frequency.setValueAtTime(300,this.ctx.currentTime),t.frequency.linearRampToValueAtTime(600,this.ctx.currentTime+.1),e.gain.setValueAtTime(.2,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.masterGain),t.start(),t.stop(this.ctx.currentTime+.1)}}var es=Oe();const ss=Ze(es);class is{constructor(t){this.networkManager=t,this.players={},this.crystals=[{id:"blue-flag",team:"blue",x:-150,y:60,z:150,originalX:-150,originalY:60,originalZ:150,state:"home",carrierId:null},{id:"red-flag",team:"red",x:-150,y:60,z:-150,originalX:-150,originalY:60,originalZ:-150,state:"home",carrierId:null}],this.scores={red:0,blue:0},this.TEAMS=["red","blue"],this.potions=[{id:"speed-1",type:"speed",x:0,y:50,z:0,active:!0,respawnTime:1e4},{id:"shield-1",type:"shield",x:-60,y:40,z:60,active:!0,respawnTime:15e3},{id:"berserk-1",type:"berserk",x:60,y:40,z:-60,active:!0,respawnTime:2e4}]}init(){this.scores={red:0,blue:0},this.resetCrystals(),this.resetPotions()}resetPotions(){this.potions.forEach(t=>t.active=!0)}resetCrystals(){this.crystals.forEach(t=>{t.x=t.originalX,t.y=t.originalY,t.z=t.originalZ,t.state="home",t.carrierId=null})}addPlayer(t,e="Unknown",s="witch"){console.log("Host: Player connected:",t,e,s),this.players[t]={id:t,name:e,characterClass:s,x:0,y:0,z:0,rx:0,ry:0,team:"spectator",biome:"forest",health:100,kills:0,deaths:0},this.networkManager.sendTo(t,"init",{id:t,players:this.players,crystals:this.crystals,potions:this.potions,scores:this.scores}),this.broadcastPlayerList()}removePlayer(t){console.log("Host: Player disconnected:",t),delete this.players[t],this.networkManager.broadcast("playerLeft",t),this.broadcastPlayerList()}broadcastPlayerList(){const t=Object.values(this.players).map(e=>({id:e.id,name:e.name,kills:e.kills,deaths:e.deaths,ping:0}));this.networkManager.broadcast("playerListUpdate",t)}startGame(){this.networkManager.broadcast("gameStarted",{})}handleMessage(t,e,s){switch(e){case"joinTeam":this.handleJoinTeam(t,s);break;case"move":this.handleMove(t,s);break;case"collectCrystal":this.handleCollectCrystal(t,s);break;case"hitPlayer":this.handleHitPlayer(t,s);break;case"chat":this.networkManager.broadcast("chat",s);break;case"captureFlag":this.handleCaptureFlag(t);break;case"requestRestart":this.resetGame();break;case"requestRespawn":this.handleRequestRespawn(t);break;case"collectPotion":this.handleCollectPotion(t,s);break}}handleCollectPotion(t,e){const s=this.potions.find(i=>i.id===e);s&&s.active&&(s.active=!1,this.networkManager.broadcast("potionUpdate",{id:e,active:!1}),this.networkManager.sendTo(t,"applyPotion",{type:s.type}),setTimeout(()=>{s.active=!0,this.networkManager.broadcast("potionUpdate",{id:e,active:!0})},s.respawnTime))}handleHitPlayer(t,e){const{targetId:s,damage:i}=e,o=this.players[s];o&&o.health>0&&(o.health-=i,o.health<0&&(o.health=0),this.networkManager.broadcast("playerDamaged",{id:s,health:o.health,shooterId:t}),o.health<=0&&this.handlePlayerDeath(s,t))}handlePlayerDeath(t,e){const s=this.players[t];if(s){s.deaths++,e&&this.players[e]&&e!==t&&this.players[e].kills++;const i=e&&this.players[e]?this.players[e].name:"Environment";this.networkManager.broadcast("killFeed",{killer:i,victim:s.name,method:"blasted"}),this.broadcastPlayerList();const o=this.crystals.find(n=>n.carrierId===t);o&&(o.state="dropped",o.carrierId=null,o.x=s.x,o.y=s.y,o.z=s.z,this.networkManager.broadcast("crystalUpdate",{id:o.id,state:"dropped",x:s.x,y:s.y,z:s.z})),this.networkManager.broadcast("playerDied",{id:t})}}handleRequestRespawn(t){const e=this.players[t];if(e){e.health=100;let s=0,i=0;e.team==="blue"?(s=-150,i=150):e.team==="red"&&(s=-150,i=-150),e.x=s,e.y=32,e.z=i,this.networkManager.sendTo(t,"teamAssigned",e),this.networkManager.broadcast("playerDamaged",{id:t,health:100}),this.networkManager.broadcast("playerJoined",e)}}handleJoinTeam(t,e){if(console.log(`Host: Player ${t} joining team ${e}`),!this.TEAMS.includes(e)){console.error(`Host: Invalid team ${e}`);return}let s=0,i=32,o=0;e==="blue"?(s=-150,o=150):e==="red"&&(s=-150,o=-150);const n=this.players[t];n?(n.team=e,n.x=s,n.y=i,n.z=o,console.log(`Host: Assigning ${t} to ${e}`),this.networkManager.sendTo(t,"teamAssigned",n),this.networkManager.broadcast("playerJoined",n)):console.error(`Host: Player ${t} not found in players list`)}handleMove(t,e){if(this.players[t]){const s=this.players[t];s.x=e.x,s.y=e.y,s.z=e.z,s.rx=e.rx,s.ry=e.ry,s.biome=e.biome,this.networkManager.broadcast("playerMoved",s,t)}}handleCollectCrystal(t,e){const s=this.crystals.find(o=>o.id===e),i=this.players[t];s&&i&&(s.team!==i.team?(s.state==="home"||s.state==="dropped")&&(s.state="carried",s.carrierId=t,this.networkManager.broadcast("crystalUpdate",{id:e,state:"carried",carrierId:t})):s.team===i.team&&s.state==="dropped"&&(s.state="home",s.carrierId=null,s.x=s.originalX,s.y=s.originalY,s.z=s.originalZ,this.networkManager.broadcast("crystalUpdate",{id:e,state:"home",x:s.originalX,y:s.originalY,z:s.originalZ})))}handleCaptureFlag(t){const e=this.players[t];if(!e)return;const s=this.crystals.find(i=>i.carrierId===t);s&&s.team!==e.team&&(this.scores[e.team]++,s.state="home",s.carrierId=null,s.x=s.originalX,s.y=s.originalY,s.z=s.originalZ,this.networkManager.broadcast("crystalCaptured",{id:s.id,team:e.team,scores:this.scores}),this.networkManager.broadcast("crystalUpdate",{id:s.id,state:"home",x:s.originalX,y:s.originalY,z:s.originalZ}),this.checkWinCondition())}checkWinCondition(){if(this.scores.red>=3||this.scores.blue>=3){let t=this.scores.red>=3?"red":"blue";this.networkManager.broadcast("gameOver",{winner:t})}}resetGame(){this.resetCrystals(),this.scores={red:0,blue:0},this.networkManager.broadcast("gameReset",{crystals:this.crystals,scores:this.scores})}}class os{constructor(){this.peer=null,this.gun=ss({peers:["https://gun-manhattan.herokuapp.com/gun","https://gun-us.herokuapp.com/gun","https://gundb-relay-ml.herokuapp.com/gun"]}),this.lobbies=this.gun.get("voxelwitchwars_v2").get("lobbies"),this.lobbyHeartbeat=null,this.conn=null,this.connections=[],this.isHost=!1,this.gameHost=null,this.playerId=null,this.playerName="Player",this.onLocalPlayerInit=null,this.onPlayerJoinedCallback=null,this.onPlayerLeftCallback=null,this.onPlayerMovedCallback=null,this.onCrystalsInit=null,this.onCrystalCollectedCallback=null,this.onScoreUpdate=null,this.onTeamAssignedCallback=null,this.onPlayerListUpdate=null,this.onGameStarted=null,this.onHealthUpdate=null,this.onPlayerHitCallback=null,this.onPlayerDied=null,this.onKillFeedCallback=null,this.onChatMessage=null,this.onPotionsInit=null,this.onPotionUpdate=null,this.onApplyPotion=null}async hostGame(t=null,e="Host",s="witch"){this.isHost=!0,this.playerName=e;const i={config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]}};console.log("Initializing Peer...");try{t?this.peer=new Nt(t,i):this.peer=new Nt(i)}catch(o){throw console.error("PeerJS Init Error:",o),new Error("Failed to initialize network: "+o.message)}return new Promise((o,n)=>{const c=setTimeout(()=>{this.peer&&this.peer.destroy(),n("Connection timed out (10s). Check firewall/network.")},1e4);this.peer.on("open",a=>{clearTimeout(c),console.log("My peer ID is: "+a),this.playerId=a;try{this.gameHost=new is(this),this.gameHost.init(),this.gameHost.addPlayer(a,e,s),this.showConnectionStatus(!0,`Hosting: ${a}`),this.publishLobby(a,t||e+"'s Game"),o(a)}catch(l){console.error("GameHost Init Error:",l),n("Failed to start GameHost: "+l.message)}}),this.peer.on("connection",a=>{this.handleConnection(a)}),this.peer.on("error",a=>{clearTimeout(c),console.error("Peer Error:",a);let l=a.type;a.type==="unavailable-id"?l="ID already taken. Try another.":a.type==="browser-incompatible"?l="Browser does not support WebRTC.":a.type==="network"&&(l="Network error. Check connection."),this.showConnectionStatus(!1,l),n(l)})})}async joinGame(t,e="Player",s="witch"){this.isHost=!1,this.playerName=e;const i={config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]}};return this.peer=new Nt(void 0,i),new Promise((o,n)=>{this.peer.on("open",c=>{this.playerId=c,console.log("My peer ID is: "+c),this.conn=this.peer.connect(t,{metadata:{name:e,characterClass:s}}),this.conn.on("open",()=>{console.log("Connected to Host"),this.showConnectionStatus(!0,"Connected to Host"),o()}),this.conn.on("data",a=>{this.handleMessage(a)}),this.conn.on("close",()=>{this.showConnectionStatus(!1,"Disconnected")}),this.conn.on("error",a=>{console.error("Connection Error",a),this.showConnectionStatus(!1,"Connection Error"),n(a)})}),this.peer.on("error",c=>{console.error("Peer Error",c),n(c)})})}handleConnection(t){console.log("Client connected:",t.peer),this.connections.push(t),t.on("open",()=>{const e=t.metadata&&t.metadata.name?t.metadata.name:"Unknown",s=t.metadata&&t.metadata.characterClass?t.metadata.characterClass:"witch";this.gameHost.addPlayer(t.peer,e,s)}),t.on("data",e=>{this.gameHost&&this.gameHost.handleMessage(t.peer,e.type,e.payload)}),t.on("close",()=>{this.connections=this.connections.filter(e=>e!==t),this.gameHost&&this.gameHost.removePlayer(t.peer)})}send(t,e){this.isHost?this.gameHost&&this.gameHost.handleMessage(this.playerId,t,e):this.conn&&this.conn.open&&this.conn.send({type:t,payload:e})}sendTo(t,e,s){if(t===this.playerId)this.handleMessage({type:e,payload:s});else{const i=this.connections.find(o=>o.peer===t);i&&i.open&&i.send({type:e,payload:s})}}broadcast(t,e,s=null){this.playerId!==s&&this.handleMessage({type:t,payload:e}),this.connections.forEach(i=>{i.peer!==s&&i.open&&i.send({type:t,payload:e})})}handleMessage(t){const{type:e,payload:s}=t;switch(e){case"playerListUpdate":this.onPlayerListUpdate&&this.onPlayerListUpdate(s);break;case"gameStarted":this.onGameStarted&&this.onGameStarted();break;case"init":s.players[this.playerId]&&this.onLocalPlayerInit&&this.onLocalPlayerInit(s.players[this.playerId]),Object.values(s.players).forEach(i=>{i.id!==this.playerId&&this.onPlayerJoined(i)}),this.onCrystalsInit&&this.onCrystalsInit(s.crystals),this.onPotionsInit&&this.onPotionsInit(s.potions),this.onScoreUpdate&&this.onScoreUpdate(s.scores);break;case"playerJoined":s.id!==this.playerId&&this.onPlayerJoined(s);break;case"playerLeft":this.onPlayerLeftCallback&&this.onPlayerLeftCallback(s);break;case"playerMoved":this.onPlayerMovedCallback&&this.onPlayerMovedCallback(s);break;case"crystalCollected":this.onCrystalCollectedCallback&&this.onCrystalCollectedCallback(s);break;case"gameOver":alert("Game Over! Winner: "+s.winner);break;case"gameReset":this.onCrystalsInit&&this.onCrystalsInit(s.crystals),this.onScoreUpdate&&this.onScoreUpdate(s.scores);break;case"teamAssigned":this.onTeamAssignedCallback&&this.onTeamAssignedCallback(s);break;case"playerDamaged":this.onPlayerHitCallback&&this.onPlayerHitCallback(s.id,s.shooterId),s.id===this.playerId&&this.onHealthUpdate&&this.onHealthUpdate(s.health);break;case"playerDied":s.id===this.playerId?this.onPlayerDied&&this.onPlayerDied():console.log(`Player ${s.id} died.`);break;case"chat":this.onChatMessage&&this.onChatMessage(s);break;case"killFeed":this.onKillFeedCallback&&this.onKillFeedCallback(s);break;case"potionUpdate":this.onPotionUpdate&&this.onPotionUpdate(s);break;case"applyPotion":this.onApplyPotion&&this.onApplyPotion(s.type);break}}sendMove(t,e,s){this.send("move",{x:t.x,y:t.y,z:t.z,rx:e.x,ry:e.y,biome:s})}collectCrystal(t){this.send("collectCrystal",t)}collectPotion(t){this.send("collectPotion",t)}sendHit(t,e){this.send("hitPlayer",{targetId:t,damage:e})}sendRespawn(t){this.send("requestRespawn",{})}sendBlockUpdate(t,e,s,i){this.send("blockUpdate",{x:t,y:e,z:s,type:i})}joinTeam(t){console.log("NetworkManager: Joining team",t),this.send("joinTeam",t)}onPlayerJoined(t){this.onPlayerJoinedCallback&&this.onPlayerJoinedCallback(t)}showConnectionStatus(t,e=""){let s=document.getElementById("connection-status");s||(s=document.createElement("div"),s.id="connection-status",s.style.position="absolute",s.style.top="10px",s.style.right="10px",s.style.padding="10px",s.style.borderRadius="5px",s.style.fontFamily="monospace",s.style.fontWeight="bold",s.style.zIndex="1000",s.style.maxWidth="300px",s.style.wordWrap="break-word",document.body.appendChild(s)),t?(s.textContent=e||" Online",s.style.backgroundColor="rgba(0, 255, 0, 0.8)",s.style.color="white"):(s.innerHTML=" Offline<br><small>"+e+"</small>",s.style.backgroundColor="rgba(255, 0, 0, 0.8)",s.style.color="white")}publishLobby(t,e){console.log("Publishing lobby:",e);const s=()=>{this.lobbies.get(t).put({id:t,name:e,players:this.connections?this.connections.length+1:1,timestamp:Date.now()})};s(),this.lobbyHeartbeat=setInterval(s,3e3),window.addEventListener("beforeunload",()=>{this.stopPublishingLobby(t)})}stopPublishingLobby(t){this.lobbyHeartbeat&&clearInterval(this.lobbyHeartbeat),this.lobbies.get(t).put(null)}subscribeToLobbies(t){console.log("Subscribing to lobbies..."),this.lobbies.map().on((e,s)=>{e&&e.timestamp>Date.now()-3e4?t(s,e):t(s,null)})}sendChat(t){this.send("chat",{id:this.playerId,name:this.playerName,message:t,timestamp:Date.now()})}}class ns{constructor(t,e){this.scene=t,this.id=e.id,this.team=e.team,this.characterClass=e.characterClass||"witch";const s=this.characterClass==="warlock"?this.createWarlockMesh():this.createWitchMesh();this.mesh=s.mesh,this.mesh.position.set(e.x,e.y,e.z);const i=e.name||"Unknown",o=this.createNameSprite(i);o.position.y=3,this.mesh.add(o),this.scene.add(this.mesh),this.targetPos=new L(e.x,e.y,e.z),this.targetRot=new Ce(e.rx,e.ry,0)}createNameSprite(t){const e=document.createElement("canvas"),s=e.getContext("2d"),i=24,o=`bold ${i}px Arial`;s.font=o;const n=s.measureText(t).width;e.width=n+20,e.height=i+10,s.fillStyle="rgba(0, 0, 0, 0.5)",s.fillRect(0,0,e.width,e.height),s.font=o,s.fillStyle="white",s.textAlign="center",s.textBaseline="middle",s.fillText(t,e.width/2,e.height/2);const c=new Le(e),a=new He({map:c}),l=new Re(a),d=.05;return l.scale.set(e.width*d,e.height*d,1),l}update(t){this.mesh.position.lerp(this.targetPos,t*10),this.mesh.rotation.y=Pt.lerp(this.mesh.rotation.y,this.targetRot.y,t*10)}updateData(t){this.targetPos.set(t.x,t.y,t.z),this.targetRot.set(t.rx,t.ry,0)}setCarrying(t){if(this.flagMesh&&(this.mesh.remove(this.flagMesh),this.flagMesh=null),t){const e=new ie(.4,0),s=new b({color:t,emissive:t,emissiveIntensity:1});this.flagMesh=new h(e,s),this.flagMesh.position.set(0,2.5,-.5),this.mesh.add(this.flagMesh)}}dispose(){this.scene.remove(this.mesh)}createWitchMesh(){const t=new et,e=new et;t.add(e),e.rotation.y=Math.PI;const s=16764074;let i=4915330;this.team==="red"?i=16711680:this.team==="blue"&&(i=255);const o=3342438,n=16711680,c=16753920,a=1118481,l=new m(.5,.8,.4),d=new b({color:i}),f=new h(l,d);f.position.y=.9,e.add(f);const p=new m(.6,.6,.5),u=new h(p,d);u.position.y=.3,e.add(u);const y=new m(.35,.35,.35),w=new b({color:s}),x=new h(y,w);x.position.y=1.5,e.add(x);const g=new b({color:c}),k=new h(new m(.45,.5,.15),g);k.position.set(0,1.5,-.2),e.add(k);const I=new h(new m(.1,.4,.4),g);I.position.set(-.2,1.5,0),e.add(I);const M=new h(new m(.1,.4,.4),g);M.position.set(.2,1.5,0),e.add(M);const S=new et,D=new b({color:o}),T=new b({color:n}),C=new h(new m(.8,.1,.8),D);C.position.y=1.7,S.add(C);const F=new h(new m(.5,.3,.5),D);F.position.y=1.9,S.add(F);const K=new h(new m(.45,.15,.45),T);K.position.y=2.1,S.add(K);const G=new h(new m(.35,.3,.35),D);G.position.y=2.3,S.add(G);const Y=new h(new m(.2,.3,.2),D);Y.position.y=2.6,S.add(Y);const q=new h(new m(.15,.2,.15),D);q.position.set(.1,2.8,0),q.rotation.z=-.2,S.add(q),e.add(S);const H=new m(.15,.5,.15),R=new b({color:i}),z=new h(H,R);z.position.set(-.35,1,0),z.rotation.z=0,e.add(z);const P=new h(H,R);P.position.set(.35,1,0),P.rotation.z=0,e.add(P);const tt=new m(.12,.12,.12),j=new b({color:s}),_=new h(tt,j);_.position.set(0,-.3,0),z.add(_);const Q=new h(tt,j);Q.position.set(0,-.3,0),P.add(Q);const $=new m(.15,.4,.15),X=new b({color:a}),W=new h($,X);W.position.set(-.15,.2,0),e.add(W);const V=new h($,X);V.position.set(.15,.2,0),e.add(V);const ot=new m(.05,.05,.05),N=new b({color:0}),U=new h(ot,N);U.position.set(-.1,1.55,.18),e.add(U);const ct=new h(ot,N);return ct.position.set(.1,1.55,.18),e.add(ct),{mesh:t,rightArm:P,leftArm:z,rightHand:Q}}createWarlockMesh(){const t=new et,e=new et;t.add(e),e.rotation.y=Math.PI;const s=16764074;let i=4915330;this.team==="red"?i=8912896:this.team==="blue"&&(i=136);const o=i,n=16711680,c=0,a=0,l=9127187,d=16766720,f=new et,p=new m(.1,.1,2),u=new b({color:l}),y=new h(p,u);y.position.set(0,.6,.2),y.rotation.x=-.1,f.add(y);const w=new m(.3,.3,.6),x=new b({color:d}),g=new h(w,x);g.position.set(0,.7,-.8),g.rotation.x=-.1,f.add(g),e.add(f);const k=new m(.45,.7,.35),I=new b({color:i}),M=new h(k,I);M.position.y=1,e.add(M);const S=new m(.5,.4,.5),D=new h(S,I);D.position.y=.7,e.add(D);const T=new m(.35,.35,.35),C=new b({color:s}),F=new h(T,C);F.position.y=1.55,e.add(F);const K=new m(.08,.08,.08),G=new h(K,C);G.position.set(0,1.5,.2),e.add(G);const Y=new b({color:c}),q=new h(new m(.4,.5,.15),Y);q.position.set(0,1.5,-.2),e.add(q);const H=new h(new m(.1,.4,.4),Y);H.position.set(-.2,1.5,0),e.add(H);const R=new h(new m(.1,.4,.4),Y);R.position.set(.2,1.5,0),e.add(R);const z=new et,P=new b({color:o}),tt=new b({color:n}),j=new h(new m(.7,.05,.7),P);j.position.y=1.75,z.add(j);const _=new h(new m(.4,.1,.4),tt);_.position.y=1.82,z.add(_);const Q=new h(new m(.35,.25,.35),P);Q.position.y=2,z.add(Q);const $=new h(new m(.25,.25,.25),P);$.position.y=2.25,z.add($);const X=new h(new m(.15,.25,.15),P);X.position.y=2.5,z.add(X);const W=new h(new m(.1,.2,.1),P);W.position.set(.05,2.7,-.05),W.rotation.z=-.2,W.rotation.x=-.2,z.add(W),e.add(z);const V=new m(.12,.45,.12),ot=new b({color:i}),N=new h(V,ot);N.position.set(-.3,1.1,.1),N.rotation.z=-.2,N.rotation.x=-.5,e.add(N);const U=new h(V,ot);U.position.set(.3,1.1,.1),U.rotation.z=.2,U.rotation.x=-.5,e.add(U);const ct=new m(.1,.1,.1),vt=new b({color:s}),at=new h(ct,vt);at.position.set(0,-.25,0),N.add(at);const lt=new h(ct,vt);lt.position.set(0,-.25,0),U.add(lt),new m(.13,.35,.13);const pt=new b({color:i}),Mt=new b({color:a}),st=new h(new m(.14,.35,.14),pt);st.position.set(-.2,.8,.1),st.rotation.x=-1,st.rotation.z=.2,e.add(st);const ht=new h(new m(.12,.3,.12),Mt);ht.position.set(0,-.25,.1),ht.rotation.x=1,st.add(ht);const J=new h(new m(.14,.35,.14),pt);J.position.set(.2,.8,.1),J.rotation.x=-1,J.rotation.z=-.2,e.add(J);const ut=new h(new m(.12,.3,.12),Mt);ut.position.set(0,-.25,.1),ut.rotation.x=1,J.add(ut);const yt=new m(.04,.04,.04),kt=new b({color:0}),xt=new h(yt,kt);xt.position.set(-.08,1.55,.18),e.add(xt);const dt=new h(yt,kt);return dt.position.set(.08,1.55,.18),e.add(dt),{mesh:t,rightArm:U,leftArm:N,rightHand:lt}}}class as{constructor(t,e,s,i){this.scene=t,this.world=e,this.particleSystem=s,this.player=i,this.volcanicIslands=[],this.burningTrees=[],this.scanForVolcanicIslands(),this.scanForTrees(),this.lavaLights=[];const o=3;for(let n=0;n<o;n++){const c=new Kt(16729088,2,20);c.visible=!1,this.scene.add(c),this.lavaLights.push(c)}this.spawnTimer=0}scanForVolcanicIslands(){if(this.world.islandCenters)for(const t of this.world.islandCenters)t.type==="volcanic"&&this.volcanicIslands.push(t)}scanForTrees(){for(const s of this.volcanicIslands){const i=Math.floor((s.x-50)/14),o=Math.floor((s.x+50)/14),n=Math.floor((s.z-50)/14),c=Math.floor((s.z+50)/14);for(let a=i;a<=o;a++)for(let l=n;l<=c;l++){const d=this.world.getTreeInGrid(a,l);d.exists&&this.burningTrees.push({x:d.x,y:30+d.height-2,z:d.z})}}}update(t){this.updateLights(),this.spawnTimer+=t,this.spawnTimer>.1&&(this.spawnTimer=0,this.spawnLavaParticles(),this.spawnTreeFire())}updateLights(){let t=1/0,e=null;const s=this.player.position;for(const i of this.volcanicIslands){const o=s.x-i.x,n=s.z-i.z,c=Math.sqrt(o*o+n*n);c<t&&(t=c,e=i)}if(e&&t<60){const i=e.x-30,o=e.z,n=performance.now()*.001;this.lavaLights.forEach((c,a)=>{c.visible=!0;const l=n*.5+a*(Math.PI*2/this.lavaLights.length),d=8+Math.sin(n*2+a)*2;c.position.set(i+Math.cos(l)*d,32,o+Math.sin(l)*d),c.intensity=2+Math.sin(n*10+a)*.5})}else this.lavaLights.forEach(i=>i.visible=!1)}spawnLavaParticles(){const t=this.player.position;for(const e of this.volcanicIslands){const s=t.x-e.x,i=t.z-e.z;if(Math.sqrt(s*s+i*i)<80){const n=e.x-30,c=e.z;for(let a=0;a<2;a++){const l=Math.sqrt(Math.random())*11,d=Math.random()*Math.PI*2,f=n+l*Math.cos(d),p=c+l*Math.sin(d),u=30.5,y=Math.random()>.5?16729344:16776960;this.particleSystem.emit(new L(f,u,p),y,1,2,1.5,5)}for(let a=0;a<1;a++){const l=e.x-30-Math.random()*30,d=e.z+(Math.random()-.5)*6,f=30.5;this.particleSystem.emit(new L(l,f,d),16729344,1,2,1,5)}}}}spawnTreeFire(){const t=this.player.position;for(const e of this.burningTrees){const s=t.x-e.x,i=t.z-e.z;if(s*s+i*i<3600){const n=(Math.random()-.5)*2,c=(Math.random()-.5)*2,a=(Math.random()-.5)*2,l=Math.random()>.5?16729344:16753920;this.particleSystem.emit(new L(e.x+n,e.y+a,e.z+c),l,1,1,.8,5)}}}}console.log("Voxel Witch Wars v1.1 Loaded");const re=document.getElementById("start-screen"),ce=document.getElementById("start-btn"),gt=document.getElementById("lobby-menu"),mt=document.getElementById("gamemode-menu"),bt=document.getElementById("campaign-menu");ce&&re&&ce.addEventListener("click",()=>{console.log("Start button clicked"),re.style.display="none",mt&&(mt.classList.remove("hidden"),mt.style.display="flex")});const le=document.getElementById("btn-mode-multiplayer"),he=document.getElementById("btn-mode-campaign");le&&le.addEventListener("click",()=>{if(mt&&mt.classList.add("hidden"),gt){gt.classList.remove("hidden"),gt.style.display="flex";const r=gt.querySelector("h1");r&&(r.textContent="Multiplayer Lobby")}});he&&he.addEventListener("click",()=>{mt&&mt.classList.add("hidden"),bt&&(bt.classList.remove("hidden"),bt.style.display="flex")});const de=document.getElementById("btn-campaign-single"),fe=document.getElementById("btn-campaign-coop"),me=document.getElementById("btn-campaign-back");me&&me.addEventListener("click",()=>{bt&&bt.classList.add("hidden"),mt&&(mt.classList.remove("hidden"),mt.style.display="flex")});fe&&fe.addEventListener("click",()=>{if(bt&&bt.classList.add("hidden"),gt){gt.classList.remove("hidden"),gt.style.display="flex";const r=gt.querySelector("h1");r&&(r.textContent="Campaign (Co-op)")}});const pe=document.getElementById("btn-lobby-back");pe&&pe.addEventListener("click",()=>{gt&&gt.classList.add("hidden"),mt&&(mt.classList.remove("hidden"),mt.style.display="flex")});const nt=new Ae;nt.background=new Wt(8900331);nt.fog=new qe(8900331,10,500);const Ut=new $e(75,window.innerWidth/window.innerHeight,.1,1e3),Lt=new We({antialias:!0});Lt.setSize(window.innerWidth,window.innerHeight);Lt.shadowMap.enabled=!0;document.body.appendChild(Lt.domElement);const Yt=new Qe(nt),Bt=new ts,v=new os,rt=new Map,zt=new Map;v.onTeamAssignedCallback=r=>{console.log("Team Assigned Callback received:",r),console.log("Team:",r.team),A.setTeam(r.team);let t=new L(150,32,150);r.team==="blue"?t.set(-150,32,150):r.team==="red"&&t.set(-150,32,-150),console.log("Spawning at:",t),A.mesh.position.copy(t),A.physicsPosition.copy(t),A.velocity.set(0,0,0),A.setSpawnPoint(t);const e=document.getElementById("start-menu"),s=document.getElementById("ui"),i=document.getElementById("score-ui"),o=document.getElementById("minimap");console.log("Hiding start menu, showing UI"),e&&e.classList.add("hidden"),s&&(s.style.display="block"),i&&(i.style.display="block"),o&&o.classList.remove("hidden"),document.body.requestPointerLock(),Bt.initWind()};v.onHealthUpdate=r=>{const t=document.getElementById("health-bar"),e=document.getElementById("health-text");t&&e&&(t.style.width=`${r}%`,e.textContent=`${Math.ceil(r)} / 100`,t.className="",r>50?t.classList.add("high"):r>25?t.classList.add("medium"):t.classList.add("low"))};v.onPlayerHitCallback=(r,t)=>{let e=null;if(r===v.playerId?(e=A.mesh.position.clone(),e.y+=1):rt.has(r)&&(e=rt.get(r).mesh.position.clone(),e.y+=1),e&&(Yt.emit(e,16711680,15,8,.5),Bt.playExplosion()),t===v.playerId){const s=document.getElementById("hit-marker");s&&(s.classList.remove("hidden"),Bt.playHitMarker(),setTimeout(()=>{s&&s.classList.add("hidden")},100))}};v.onPlayerDied=()=>{console.log("You Died!"),A.onDeath();const r=document.getElementById("respawn-menu");r&&(r.classList.remove("hidden"),r.style.display="flex",document.exitPointerLock())};const ue=document.getElementById("respawn-btn");ue&&ue.addEventListener("click",()=>{v.send("requestRespawn",{});const r=document.getElementById("respawn-menu");r&&(r.classList.add("hidden"),r.style.display="none"),A.isDead=!1,A.health=100,document.body.requestPointerLock()});document.querySelectorAll(".team-btn").forEach(r=>{r.addEventListener("click",t=>{const e=t.currentTarget.dataset.team;console.log("Team selected:",e),document.getElementById("team-select").style.display="none",document.getElementById("loading-msg").style.display="block",v.joinTeam(e)})});v.onPlayerJoinedCallback=r=>{console.log("Player Joined:",r.id);const t=new ns(nt,r);rt.set(r.id,t)};v.onPlayerLeftCallback=r=>{console.log("Player Left:",r),rt.has(r)&&(rt.get(r).dispose(),rt.delete(r))};v.onPlayerMovedCallback=r=>{rt.has(r.id)&&rt.get(r.id).updateData(r)};let Vt=[];v.onCrystalsInit=r=>{Vt=r,zt.forEach(e=>nt.remove(e)),zt.clear();const t=new ie(1,0);r.forEach(e=>{const s=e.team==="blue"?255:16711680,i=new b({color:s,emissive:s,emissiveIntensity:2});if(e.state==="home"||e.state==="dropped"){const o=new h(t,i);o.position.set(e.x,e.y,e.z);const n=new Kt(s,2,20);o.add(n),nt.add(o),zt.set(e.id,o)}})};v.onCrystalUpdate=r=>{const t=Vt.find(e=>e.id===r.id);if(t){const e=t.carrierId;if(Object.assign(t,r),e&&e!==r.carrierId&&rt.has(e)&&rt.get(e).setCarrying(null),r.state==="carried"&&r.carrierId&&rt.has(r.carrierId)){const s=t.team==="blue"?255:16711680;rt.get(r.carrierId).setCarrying(s)}if(r.state==="carried"){if(zt.has(r.id)){const s=zt.get(r.id);nt.remove(s),zt.delete(r.id)}}else if(r.state==="dropped"||r.state==="home")if(zt.has(r.id))zt.get(r.id).position.set(r.x,r.y,r.z);else{const s=t.team==="blue"?255:16711680,i=new ie(1,0),o=new b({color:s,emissive:s,emissiveIntensity:2}),n=new h(i,o);n.position.set(r.x,r.y,r.z);const c=new Kt(s,2,20);n.add(c),nt.add(n),zt.set(r.id,n)}}};v.onCrystalCaptured=r=>{Bt.playExplosion(),Zt(r.scores);const t=`${r.team.toUpperCase()} Team Captured the Flag!`;oe("System",t,!0)};v.onCrystalCollectedCallback=r=>{r.team,r.scores&&Zt(r.scores)};v.onScoreUpdate=r=>{Zt(r)};v.onGameOver=r=>{const t=document.getElementById("game-over-screen"),e=document.getElementById("game-over-title"),s=document.getElementById("game-over-msg");if(t&&e&&s){t.classList.remove("hidden"),t.style.display="flex";const i=A.team,o=r.winner;i===o?(e.textContent="VICTORY",e.style.color="#ffff00",s.textContent=`${o.toUpperCase()} TEAM WINS!`,Bt.playExplosion()):(e.textContent="DEFEAT",e.style.color="#ff0000",s.textContent=`${o.toUpperCase()} TEAM WINS!`),document.exitPointerLock()}};v.onGameReset=r=>{const t=document.getElementById("game-over-screen");t&&(t.classList.add("hidden"),t.style.display="none"),Zt(r.scores),v.onCrystalsInit&&v.onCrystalsInit(r.crystals),A.health=100,A.isDead=!1;let e=new L(0,32,0);A.team==="blue"?e.set(-150,32,150):A.team==="red"&&e.set(-150,32,-150),A.mesh.position.copy(e),A.physicsPosition.copy(e),A.velocity.set(0,0,0),oe("System","Game has been reset!",!0)};const ye=document.getElementById("play-again-btn");ye&&ye.addEventListener("click",()=>{v.send("requestRestart",{})});function Zt(r){const t=document.getElementById("score-ui");t&&(t.innerHTML=`
            <span style="color: #ff4444">Red: ${r.red}</span> | 
            <span style="color: #4444ff">Blue: ${r.blue}</span>
        `)}const rs=new ke(500,32,32),cs=new Ue({uniforms:{topColor:{value:new Wt(30719)},bottomColor:{value:new Wt(16777215)},offset:{value:33},exponent:{value:.6}},vertexShader:`
        varying vec3 vWorldPosition;
        void main() {
            vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
            vWorldPosition = worldPosition.xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    `,fragmentShader:`
        uniform vec3 topColor;
        uniform vec3 bottomColor;
        uniform float offset;
        uniform float exponent;
        varying vec3 vWorldPosition;
        void main() {
            float h = normalize( vWorldPosition + offset ).y;
            gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
        }
    `,side:Ve}),ls=new h(rs,cs);nt.add(ls);const hs=new Xe(13421772,.6);nt.add(hs);const Ht=new Ke(16777215,.8);Ht.position.set(20,50,20);Ht.castShadow=!0;Ht.shadow.mapSize.width=2048;Ht.shadow.mapSize.height=2048;nt.add(Ht);const St=new je({chunkSize:32,tileSize:1});nt.add(St.mesh);const ds=St.findSpawnPoint(),A=new Je(nt,Ut,St,ds,Yt,Bt,v),fs=new as(nt,St,Yt,A),Et=document.getElementById("lobby-status"),we=document.getElementById("btn-host"),ge=document.getElementById("btn-join"),ms=document.getElementById("input-host-id"),ps=document.getElementById("input-custom-host-id"),ze=document.getElementById("input-player-name"),ve=document.getElementById("waiting-room"),De=document.getElementById("main-menu-buttons"),_t=document.getElementById("player-list"),Xt=document.getElementById("start-game-btn"),Te=document.getElementById("waiting-msg"),Ie=document.getElementById("lobby-name-display"),Qt=r=>r&&r.classList.remove("hidden"),te=r=>r&&r.classList.add("hidden");v.onPlayerListUpdate=r=>{_t&&(_t.innerHTML="",r.forEach(e=>{const s=document.createElement("li"),i=e.id===v.playerId,o=document.createElement("span");o.className="name",o.textContent=`${e.name} ${i?" (You)":""}`,s.appendChild(o),_t.appendChild(s)}));const t=document.getElementById("scoreboard-body");t&&(t.innerHTML="",[...r].sort((s,i)=>(i.kills||0)-(s.kills||0)).forEach(s=>{const i=document.createElement("tr");i.innerHTML=`
                <td>${s.name}</td>
                <td>${s.kills||0}</td>
                <td>${s.deaths||0}</td>
                <td>${s.ping||0}ms</td>
            `,t.appendChild(i)}))};v.onGameStarted=()=>{console.log("Game Started!"),gt&&gt.classList.add("hidden");const r=document.getElementById("start-screen");r&&(r.style.display="none");const t=document.getElementById("start-menu");t&&(t.classList.remove("hidden"),t.style.display="flex")};we&&we.addEventListener("click",async()=>{const r=ze.value||"Player",t=ps.value;Et.textContent="Creating lobby...";try{const e=await v.hostGame(t,r,Gt);te(De),Qt(ve),Qt(Xt),Ie.textContent=`Lobby ID: ${e}`,Te.textContent="Waiting for players..."}catch(e){console.error("Failed to host:",e),Et.textContent="Error: "+e.message}});ge&&ge.addEventListener("click",async()=>{const r=ze.value||"Player",t=ms.value;if(!t){Et.textContent="Please enter a Host ID";return}Et.textContent="Joining lobby...";try{await v.joinGame(t,r,Gt),te(De),Qt(ve),te(Xt),Ie.textContent=`Lobby ID: ${t}`,Te.textContent="Connected! Waiting for host to start..."}catch(e){console.error("Failed to join:",e),Et.textContent="Error: "+e.message}});Xt&&Xt.addEventListener("click",()=>{v.gameHost&&v.gameHost.startGame()});let Gt="witch";const qt=document.getElementById("btn-class-witch"),$t=document.getElementById("btn-class-warlock");qt&&$t&&(qt.addEventListener("click",()=>{Gt="witch",qt.classList.add("selected"),$t.classList.remove("selected"),A.setCharacterClass("witch")}),$t.addEventListener("click",()=>{Gt="warlock",$t.classList.add("selected"),qt.classList.remove("selected"),A.setCharacterClass("warlock")}));de&&de.addEventListener("click",async()=>{bt&&bt.classList.add("hidden");const r="Player";try{await v.hostGame(null,r,Gt),v.gameHost&&(v.gameHost.startGame(),setTimeout(()=>{v.send("joinTeam","blue")},100))}catch(t){console.error("Failed to start single player:",t),alert("Failed to start single player: "+t),bt&&bt.classList.remove("hidden")}});let xe=performance.now(),be=0;function us(){if(!A||!A.mesh||!v.playerId)return;const r=performance.now();if(r-be<100)return;be=r;const t=A.mesh.position,e=3,s=Vt.find(i=>i.carrierId===v.playerId);Vt.forEach(i=>{const o=t.x-i.x,n=t.y-i.y,c=t.z-i.z;Math.sqrt(o*o+n*n+c*c)<e&&((i.state==="home"||i.state==="dropped")&&(s||(i.team!==A.team||i.team===A.team&&i.state==="dropped")&&v.collectCrystal(i.id)),i.team===A.team&&i.state==="home"&&s&&v.send("captureFlag",{}))})}function Pe(){requestAnimationFrame(Pe);const r=performance.now(),t=(r-xe)/1e3;xe=r,document.pointerLockElement===document.body&&(A.update(t,rt),rt.forEach(e=>e.update(t)),Yt.update(t),fs.update(t),St.update(A.mesh.position),ee&&ee.update(),us()),Lt.render(nt,Ut)}Pe();window.addEventListener("resize",()=>{Ut.aspect=window.innerWidth/window.innerHeight,Ut.updateProjectionMatrix(),Lt.setSize(window.innerWidth,window.innerHeight)});const It=document.getElementById("chat-input"),Me=document.getElementById("chat-container");It&&It.addEventListener("keydown",r=>{if(r.key==="Enter"){const t=It.value.trim();t&&(v.sendChat(t),It.value="",It.blur(),document.body.requestPointerLock())}});document.addEventListener("keydown",r=>{r.key==="Enter"&&document.activeElement!==It&&Me&&!Me.classList.contains("hidden")&&(It.focus(),document.exitPointerLock(),r.preventDefault())});function oe(r,t,e=!1){const s=document.getElementById("chat-messages");if(s){const i=document.createElement("div");i.className="chat-message",e&&i.classList.add("system");const o=document.createElement("span");o.className="name",o.textContent=r+": ";const n=document.createElement("span");n.textContent=t,i.appendChild(o),i.appendChild(n),s.appendChild(i),s.scrollTop=s.scrollHeight}}v.onChatMessage=r=>{oe(r.name,r.message)};const ys=document.getElementById("minimap");let ee=null;ys&&(ee=new _e(St,A));v.onLocalPlayerInit=r=>{console.log("Local Player Init:",r),r.characterClass&&A.setCharacterClass(r.characterClass)};
